<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Colorímetro JS</title>
  <style>
    body { font-family: Arial, sans-serif; padding:10px; background:#f8f8f8;}
    video { width:100%; max-width:600px; border:2px solid #333; border-radius:8px; }
    canvas { display:none; }
    .box { margin-top:12px; }
    button { padding:8px 14px; margin:5px; border:none; border-radius:6px; background:#007bff; color:#fff; cursor:pointer;}
    button:hover { background:#0056b3; }
    #info { margin-top:12px; padding:10px; background:#fff; border-radius:6px; border:1px solid #ccc; white-space:pre-line; }
  </style>
</head>
<body>
  <h2>Colorímetro Digital (JavaScript)</h2>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <div class="box">
    <button id="calibrate">Calibrar Branco/Cinza</button>
    <button id="captureRef">Salvar Referência</button>
    <button id="measure">Medir ΔE</button>
  </div>

  <div id="info">Aguardando…</div>

<script>
// ===== Conversões de cor =====
function rgb2xyz(r,g,b){
  r/=255; g/=255; b/=255;
  r = r>0.04045? Math.pow((r+0.055)/1.055,2.4): r/12.92;
  g = g>0.04045? Math.pow((g+0.055)/1.055,2.4): g/12.92;
  b = b>0.04045? Math.pow((b+0.055)/1.055,2.4): b/12.92;
  r*=100; g*=100; b*=100;
  return {
    x: r*0.4124 + g*0.3576 + b*0.1805,
    y: r*0.2126 + g*0.7152 + b*0.0722,
    z: r*0.0193 + g*0.1192 + b*0.9505
  };
}
function xyz2lab(x,y,z){
  let refX=95.047, refY=100.000, refZ=108.883;
  x/=refX; y/=refY; z/=refZ;
  [x,y,z] = [x,y,z].map(v=> v>0.008856? Math.pow(v,1/3): (7.787*v)+(16/116));
  return { L: (116*y)-16, a: 500*(x-y), b: 200*(y-z) };
}
function rgb2lab(r,g,b){
  let {x,y,z} = rgb2xyz(r,g,b);
  return xyz2lab(x,y,z);
}
// ΔE2000
function deltaE2000(lab1, lab2){
  let L1=lab1.L, a1=lab1.a, b1=lab1.b;
  let L2=lab2.L, a2=lab2.a, b2=lab2.b;
  let kL=1,kC=1,kH=1;
  let C1=Math.sqrt(a1*a1+b1*b1);
  let C2=Math.sqrt(a2*a2+b2*b2);
  let Cbar=(C1+C2)/2;
  let G=0.5*(1-Math.sqrt(Math.pow(Cbar,7)/(Math.pow(Cbar,7)+Math.pow(25,7))));
  let a1p=(1+G)*a1;
  let a2p=(1+G)*a2;
  let C1p=Math.sqrt(a1p*a1p+b1*b1);
  let C2p=Math.sqrt(a2p*a2p+b2*b2);
  let h1p=Math.atan2(b1,a1p); if(h1p<0)h1p+=2*Math.PI;
  let h2p=Math.atan2(b2,a2p); if(h2p<0)h2p+=2*Math.PI;
  let dLp=L2-L1;
  let dCp=C2p-C1p;
  let dhp=h2p-h1p;
  if(Math.abs(dhp)>Math.PI){
    if(h2p<=h1p) dhp+=2*Math.PI;
    else dhp-=2*Math.PI;
  }
  let dHp=2*Math.sqrt(C1p*C2p)*Math.sin(dhp/2);
  let Lbar=(L1+L2)/2;
  let Cbarp=(C1p+C2p)/2;
  let hbarp=(Math.abs(h1p-h2p)>Math.PI)? (h1p+h2p+2*Math.PI)/2 : (h1p+h2p)/2;
  let T=1-0.17*Math.cos(hbarp-Math.PI/6)+0.24*Math.cos(2*hbarp)+0.32*Math.cos(3*hbarp+Math.PI/30)-0.20*Math.cos(4*hbarp-21*Math.PI/60);
  let Sl=1+((0.015*Math.pow(Lbar-50,2))/Math.sqrt(20+Math.pow(Lbar-50,2)));
  let Sc=1+0.045*Cbarp;
  let Sh=1+0.015*Cbarp*T;
  let Rt=-2*Math.sqrt(Math.pow(Cbarp,7)/(Math.pow(Cbarp,7)+Math.pow(25,7)))*Math.sin(Math.PI/3*Math.exp(-Math.pow((hbarp*180/Math.PI-275)/25,2)));
  return Math.sqrt(Math.pow(dLp/(kL*Sl),2)+Math.pow(dCp/(kC*Sc),2)+Math.pow(dHp/(kH*Sh),2)+Rt*(dCp/(kC*Sc))*(dHp/(kH*Sh)));
}

// ===== Captura câmera =====
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const info=document.getElementById('info');
let refLab=null;
let calibration={r:1,g:1,b:1};

async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    video.srcObject=stream;
  }catch(e){info.innerText='Erro: '+e.message;}
}

function samplePixel(){
  const w=video.videoWidth, h=video.videoHeight;
  canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(video,0,0,w,h);
  const region=10, cx=Math.floor(w/2-region/2), cy=Math.floor(h/2-region/2);
  const img=ctx.getImageData(cx,cy,region,region).data;
  let r=0,g=0,b=0,count=0;
  for(let i=0;i<img.length;i+=4){r+=img[i];g+=img[i+1];b+=img[i+2];count++;}
  // aplica calibração
  r=Math.min(255,r/count*calibration.r);
  g=Math.min(255,g/count*calibration.g);
  b=Math.min(255,b/count*calibration.b);
  return {r:Math.round(r), g:Math.round(g), b:Math.round(b)};
}

// ===== Botões =====
document.getElementById('calibrate').addEventListener('click',()=>{
  const rgb=samplePixel();
  // Assume alvo = cinza neutro (R=G=B). Pegamos a média
  const avg=(rgb.r+rgb.g+rgb.b)/3;
  calibration.r=avg/rgb.r;
  calibration.g=avg/rgb.g;
  calibration.b=avg/rgb.b;
  info.innerText=`Calibração aplicada!\nRGB capturado: (${rgb.r},${rgb.g},${rgb.b})\nCorreção: R*${calibration.r.toFixed(2)}, G*${calibration.g.toFixed(2)}, B*${calibration.b.toFixed(2)}`;
});

document.getElementById('captureRef').addEventListener('click',()=>{
  const rgb=samplePixel();
  refLab=rgb2lab(rgb.r,rgb.g,rgb.b);
  info.innerText=`Referência salva: RGB(${rgb.r},${rgb.g},${rgb.b})\nLab(${refLab.L.toFixed(2)}, ${refLab.a.toFixed(2)}, ${refLab.b.toFixed(2)})`;
});

document.getElementById('measure').addEventListener('click',()=>{
  if(!refLab){info.innerText='Primeiro salve uma referência!'; return;}
  const rgb=samplePixel();
  const lab=rgb2lab(rgb.r,rgb.g,rgb.b);
  const dE=deltaE2000(lab,refLab);
  info.innerText=`Medida: RGB(${rgb.r},${rgb.g},${rgb.b})\nLab(${lab.L.toFixed(2)}, ${lab.a.toFixed(2)}, ${lab.b.toFixed(2)})\nΔE2000 = ${dE.toFixed(2)}`;
});

// start
startCamera();
</script>
</body>
</html>
